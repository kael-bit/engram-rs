<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>engram</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { background:#111; color:#ccc; font:13px/1.6 system-ui, sans-serif; }
.app { display:flex; height:100vh; }

.sidebar { width:200px; background:#161616; border-right:1px solid #252525; display:flex; flex-direction:column; flex-shrink:0; }
.sidebar h1 { padding:12px 14px; font-size:15px; font-weight:600; color:#eee; border-bottom:1px solid #252525; }
.sidebar h1 small { font-weight:400; font-size:10px; color:#666; margin-left:4px; }
.nav-group { padding:4px 6px; }
.nav-group-label { font-size:10px; color:#555; padding:8px 8px 2px; text-transform:uppercase; }
.nav { list-style:none; }
.nav li { padding:5px 8px; border-radius:4px; cursor:pointer; font-size:12px; color:#888; display:flex; align-items:center; gap:6px; }
.nav li:hover { color:#ccc; background:#1e1e1e; }
.nav li.active { color:#fff; background:#2a2a2a; }
.nav .ct { margin-left:auto; font-size:10px; color:#555; }
.nav li.active .ct { color:#999; }
.sidebar-footer { margin-top:auto; padding:8px 6px; border-top:1px solid #252525; display:flex; flex-direction:column; gap:3px; }
.sidebar-footer button { background:none; border:1px solid #2a2a2a; border-radius:4px; padding:4px; color:#777; cursor:pointer; font-size:11px; }
.sidebar-footer button:hover { color:#ccc; border-color:#444; }

.main { flex:1; overflow-y:auto; padding:20px 24px; }
.main h2 { font-size:16px; font-weight:600; color:#eee; margin-bottom:14px; }

.stats { display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap; }
.sc { background:#1a1a1a; border:1px solid #252525; border-radius:6px; padding:10px 14px; min-width:85px; }
.sc .v { font-size:20px; font-weight:600; color:#eee; }
.sc .l { font-size:10px; color:#666; }
.sc.buf .v { color:#5b9cf5; }
.sc.wrk .v { color:#d4a44a; }
.sc.cor .v { color:#a87adb; }

.row { display:flex; gap:6px; margin-bottom:10px; flex-wrap:wrap; align-items:center; }
input[type=text], input[type=number], select, textarea {
  background:#1a1a1a; border:1px solid #2a2a2a; border-radius:4px;
  padding:6px 10px; color:#ccc; font-size:12px; outline:none; font-family:inherit;
}
input:focus, textarea:focus, select:focus { border-color:#555; }
textarea { resize:vertical; }
.btn { background:#3573e0; color:#fff; border:none; border-radius:4px; padding:6px 14px; cursor:pointer; font-size:12px; }
.btn:hover { background:#4080ee; }
.btn-danger { background:#c0392b; }
.btn-danger:hover { background:#d44; }
.btn-ghost { background:none; border:1px solid #2a2a2a; color:#888; }
.btn-ghost:hover { color:#ccc; border-color:#444; }
label { font-size:11px; color:#888; }

.ml { display:flex; flex-direction:column; gap:4px; }
.mc { background:#1a1a1a; border:1px solid #222; border-radius:6px; padding:10px 14px; cursor:pointer; }
.mc:hover { border-color:#333; }
.mc .ct { white-space:pre-wrap; word-break:break-word; font-size:12px; line-height:1.5; }
.mc .meta { display:flex; gap:8px; margin-top:6px; font-size:10px; color:#666; flex-wrap:wrap; align-items:center; }
.mc .score { color:#4caf50; font-weight:600; }
.lb { display:inline-block; padding:1px 6px; border-radius:3px; font-size:10px; font-weight:600; }
.l1 { background:rgba(91,156,245,.12); color:#5b9cf5; }
.l2 { background:rgba(212,164,74,.12); color:#d4a44a; }
.l3 { background:rgba(168,122,219,.12); color:#a87adb; }
.tag { display:inline-block; padding:1px 5px; border-radius:3px; font-size:9px; background:#222; color:#777; }
.kind-badge { display:inline-block; padding:1px 5px; border-radius:3px; font-size:9px; background:rgba(76,175,80,.12); color:#4caf50; }

.panel-bg { position:fixed; inset:0; background:rgba(0,0,0,.4); z-index:19; display:none; }
.panel-bg.open { display:block; }
.detail { position:fixed; top:0; right:0; bottom:0; width:440px; background:#161616; border-left:1px solid #252525; z-index:20; overflow-y:auto; padding:20px; transform:translateX(100%); transition:transform .2s; }
.detail.open { transform:translateX(0); }
.detail .close-btn { float:right; background:none; border:none; color:#666; font-size:16px; cursor:pointer; }
.detail .close-btn:hover { color:#ccc; }
.df { margin-bottom:10px; }
.df .dl { font-size:10px; color:#555; margin-bottom:3px; text-transform:uppercase; }
.df .dv { font-size:12px; color:#999; white-space:pre-wrap; word-break:break-word; }
.bar { height:4px; background:#222; border-radius:2px; margin-top:4px; }
.bar-fill { height:100%; border-radius:2px; }
.detail-btns { display:flex; gap:6px; margin-top:16px; padding-top:12px; border-top:1px solid #252525; }

.toast-wrap { position:fixed; top:12px; right:12px; z-index:100; display:flex; flex-direction:column; gap:6px; }
.toast { padding:8px 14px; border-radius:6px; font-size:12px; color:#fff; animation:fadeIn .15s; max-width:340px; }
.toast.ok { background:#2e7d32; }
.toast.err { background:#c0392b; }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }

.empty { text-align:center; padding:40px; color:#555; font-size:12px; }
.ftable { width:100%; border-collapse:collapse; font-size:12px; }
.ftable th, .ftable td { padding:5px 10px; border-bottom:1px solid #222; text-align:left; }
.ftable th { color:#555; font-size:10px; text-transform:uppercase; }
.ftable tr:hover { background:#1c1c1c; }
.dot { width:7px; height:7px; border-radius:50%; display:inline-block; }
.dot.on { background:#4caf50; }
.dot.off { background:#c0392b; }
.pager { display:flex; gap:6px; margin-top:10px; align-items:center; justify-content:center; font-size:11px; color:#555; }
.pager button { background:#1a1a1a; border:1px solid #2a2a2a; color:#888; border-radius:3px; padding:3px 10px; cursor:pointer; font-size:11px; }
.pager button:disabled { opacity:.3; }
.card { background:#1a1a1a; border:1px solid #252525; border-radius:6px; padding:14px 16px; margin-bottom:10px; }

@media(max-width:768px) {
  .sidebar { width:48px; }
  .sidebar h1, .nav .nl, .nav .ct, .sidebar-footer, .nav-group-label { display:none; }
  .detail { width:100%; }
}
</style>
</head>
<body>
<div class="app">
<div class="sidebar">
  <h1>engram<small id="ver"></small></h1>
  <div class="nav-group">
    <div class="nav-group-label">Memory</div>
    <ul class="nav" id="nav">
      <li class="active" data-v="all"><span class="nl">All</span><span class="ct" id="c-all">0</span></li>
      <li data-v="buffer"><span class="nl">Buffer</span><span class="ct" id="c-buf">0</span></li>
      <li data-v="working"><span class="nl">Working</span><span class="ct" id="c-wrk">0</span></li>
      <li data-v="core"><span class="nl">Core</span><span class="ct" id="c-cor">0</span></li>
    </ul>
    <div class="nav-group-label">Search</div>
    <ul class="nav" id="nav2">
      <li data-v="recall"><span class="nl">Recall</span></li>
      <li data-v="search"><span class="nl">Search</span></li>
      <li data-v="resume"><span class="nl">Resume</span></li>
    </ul>
    <div class="nav-group-label">Manage</div>
    <ul class="nav" id="nav3">
      <li data-v="create"><span class="nl">Create</span></li>
      <li data-v="facts"><span class="nl">Facts</span></li>
      <li data-v="proxy"><span class="nl">Proxy</span><span class="ct" id="c-prx">0</span></li>
      <li data-v="health"><span class="nl">Health</span></li>
      <li data-v="trash"><span class="nl">Trash</span><span class="ct" id="c-trash">0</span></li>
      <li data-v="tools"><span class="nl">Tools</span></li>
      <li data-v="tests"><span class="nl">Tests</span></li>
    </ul>
  </div>
  <div class="sidebar-footer">
    <button onclick="doAction('/consolidate','POST','{}')">Consolidate</button>
    <button onclick="doAction('/repair','POST')">Repair FTS</button>
  </div>
</div>
<div class="main" id="main"></div>
<div class="panel-bg" id="panelBg" onclick="closeDetail()"></div>
<div class="detail" id="detail"></div>
</div>
<div class="toast-wrap" id="toasts"></div>

<script>
const A=location.origin;
let allMem=[],stats={},health={},curView='all',page=0;
const PP=50;
let sortBy='created_at',sortDir=1;

function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function ln(l){return['','Buffer','Working','Core'][l]||'?';}
function lc(n){return{buffer:1,working:2,core:3}[n]||0;}
function ago(ms){
  const s=(Date.now()-ms)/1e3;
  if(s<60)return Math.floor(s)+'s';
  if(s<3600)return Math.floor(s/60)+'m';
  if(s<86400)return Math.floor(s/3600)+'h';
  return Math.floor(s/86400)+'d';
}
function toast(msg,ok=true){
  const el=document.createElement('div');
  el.className='toast '+(ok?'ok':'err');
  el.textContent=msg;
  document.getElementById('toasts').appendChild(el);
  setTimeout(()=>el.remove(),3000);
}

async function api(path,opts={}){
  const tk=localStorage.getItem('engram_token')||'';
  const h={'Content-Type':'application/json',...opts.headers};
  if(tk)h['Authorization']='Bearer '+tk;
  const res=await fetch(A+path,{...opts,headers:h});
  if(res.status===401){
    const t=prompt('Auth token:');
    if(t){localStorage.setItem('engram_token',t);return api(path,opts);}
    throw new Error('Unauthorized');
  }
  if(res.status===204)return{};
  const text=await res.text();
  try{return JSON.parse(text);}catch{return text;}
}

async function loadStats(){
  const[s,h]=await Promise.all([api('/stats'),api('/health')]);
  stats=s;health=h;
  document.getElementById('c-all').textContent=s.total;
  document.getElementById('c-buf').textContent=s.buffer;
  document.getElementById('c-wrk').textContent=s.working;
  document.getElementById('c-cor').textContent=s.core;
  document.getElementById('ver').textContent=' v'+(h.version||'?');
}

async function loadMem(){
  const d=await api('/memories?limit=10000');
  allMem=Array.isArray(d)?d:(d.memories||[]);
  allMem.sort((a,b)=>b.created_at-a.created_at);
  document.getElementById('c-prx').textContent=allMem.filter(m=>m.source==='proxy').length;
}

function card(m,score,rel){
  const tags=(m.tags||[]).map(t=>`<span class="tag">${esc(t)}</span>`).join(' ');
  const sc=score!=null?`<span class="score">${score.toFixed(3)}</span>`:'';
  const rl=rel!=null?`<span class="score" style="opacity:.6">rel ${rel.toFixed(3)}</span>`:'';
  const kind=m.kind&&m.kind!=='semantic'?`<span class="kind-badge">${m.kind}</span>`:'';
  return`<div class="mc" data-id="${m.id}">
    <div class="ct">${esc((m.content||'').slice(0,280))}${m.content&&m.content.length>280?'…':''}</div>
    <div class="meta"><span class="lb l${m.layer}">${ln(m.layer)}</span>${sc}${rl}${kind}
      <span>imp ${(m.importance||0).toFixed(2)}</span><span>×${m.access_count||0}</span>
      <span>${ago(m.created_at)}</span>${tags}</div></div>`;
}

function getMem(){
  if(curView==='proxy')return allMem.filter(m=>m.source==='proxy');
  if(['buffer','working','core'].includes(curView))return allMem.filter(m=>m.layer===lc(curView));
  return allMem;
}
function sortMem(a){return[...a].sort((a,b)=>(b[sortBy]-a[sortBy])*sortDir);}

function renderList(mems,scores){
  const M=document.getElementById('main');
  const sorted=scores?mems:sortMem(mems);
  const total=sorted.length;
  const paged=sorted.slice(page*PP,(page+1)*PP);
  const pages=Math.ceil(total/PP);
  M.innerHTML=`
    <h2>${{all:'All',buffer:'Buffer',working:'Working',core:'Core',proxy:'Proxy'}[curView]||'Memories'}</h2>
    <div class="stats">
      <div class="sc"><div class="v">${stats.total||0}</div><div class="l">Total</div></div>
      <div class="sc buf"><div class="v">${stats.buffer||0}</div><div class="l">Buffer</div></div>
      <div class="sc wrk"><div class="v">${stats.working||0}</div><div class="l">Working</div></div>
      <div class="sc cor"><div class="v">${stats.core||0}</div><div class="l">Core</div></div>
    </div>
    <div class="row">
      <input type="text" id="flt" placeholder="Filter..." style="flex:1" oninput="applyFilter()">
      <select id="sortSel" onchange="changeSort(this.value)" style="width:130px">
        <option value="created_at">Newest</option>
        <option value="importance">Importance</option>
        <option value="access_count">Access count</option>
        <option value="last_accessed">Last accessed</option>
      </select>
    </div>
    <div class="ml" id="memList">${paged.length?paged.map((m,i)=>card(m,scores?scores[page*PP+i]:null)).join(''):'<div class="empty">No memories</div>'}</div>
    ${pages>1?`<div class="pager">
      <button onclick="goPage(${page-1})" ${page===0?'disabled':''}>Prev</button>
      <span>${page+1}/${pages} (${total})</span>
      <button onclick="goPage(${page+1})" ${page>=pages-1?'disabled':''}>Next</button>
    </div>`:''}`;
  bindCards();
}

function goPage(p){page=Math.max(0,p);switchView(curView);}
function changeSort(v){sortBy=v;page=0;switchView(curView);}
function applyFilter(){
  const q=(document.getElementById('flt')||{}).value||'';
  let mems=getMem();
  if(q){const ql=q.toLowerCase();mems=mems.filter(m=>(m.content||'').toLowerCase().includes(ql)||(m.tags||[]).some(t=>t.toLowerCase().includes(ql))||m.id.startsWith(ql));}
  const el=document.getElementById('memList');
  if(el){el.innerHTML=sortMem(mems).slice(0,PP).map(m=>card(m)).join('')||'<div class="empty">No matches</div>';bindCards();}
}
function bindCards(){document.getElementById('main').querySelectorAll('.mc').forEach(c=>{c.onclick=()=>showDetail(c.dataset.id);});}

function showDetail(id){
  const m=allMem.find(x=>x.id===id);if(!m)return;
  const p=document.getElementById('detail');
  const imp=(m.importance*100).toFixed(0);
  p.innerHTML=`
    <button class="close-btn" onclick="closeDetail()">×</button>
    <h3 style="margin-bottom:14px"><span class="lb l${m.layer}">${ln(m.layer)}</span> Memory</h3>
    <div class="df"><div class="dl">ID</div><div class="dv" style="font-size:10px;color:#555">${m.id}</div></div>
    <div class="df"><div class="dl">Content</div>
      <textarea id="editContent" rows="6" style="width:100%">${esc(m.content)}</textarea>
    </div>
    <div class="df"><div class="dl">Importance (${imp}%)</div>
      <input type="range" id="editImp" min="0" max="1" step="0.05" value="${m.importance}" style="width:100%">
      <div class="bar"><div class="bar-fill" style="width:${imp}%;background:${m.importance>.7?'#4caf50':m.importance>.4?'#d4a44a':'#555'}"></div></div>
    </div>
    <div class="df"><div class="dl">Layer</div>
      <select id="editLayer" style="width:100%">
        <option value="1" ${m.layer===1?'selected':''}>Buffer</option>
        <option value="2" ${m.layer===2?'selected':''}>Working</option>
        <option value="3" ${m.layer===3?'selected':''}>Core</option>
      </select>
    </div>
    <div class="df"><div class="dl">Tags</div>
      <input type="text" id="editTags" value="${(m.tags||[]).join(', ')}" style="width:100%">
    </div>
    <div class="df"><div class="dl">Kind</div><div class="dv">${m.kind||'semantic'}</div></div>
    <div class="df"><div class="dl">Source</div><div class="dv">${esc(m.source||'—')}</div></div>
    <div class="df"><div class="dl">Access / Repetition</div><div class="dv">${m.access_count||0} / ${m.repetition_count||0}</div></div>
    <div class="df"><div class="dl">Namespace</div><div class="dv">${esc(m.namespace||'default')}</div></div>
    <div class="df"><div class="dl">Created</div><div class="dv">${new Date(m.created_at).toLocaleString()}</div></div>
    <div class="df"><div class="dl">Last accessed</div><div class="dv">${new Date(m.last_accessed).toLocaleString()}</div></div>
    <div class="df"><div class="dl">Decay rate</div><div class="dv">${m.decay_rate}</div></div>
    <div class="detail-btns">
      <button class="btn" onclick="saveMem('${m.id}')">Save</button>
      <button class="btn btn-danger" onclick="deleteMem('${m.id}')">Delete</button>
    </div>`;
  p.classList.add('open');
  document.getElementById('panelBg').classList.add('open');
}

function closeDetail(){
  document.getElementById('detail').classList.remove('open');
  document.getElementById('panelBg').classList.remove('open');
}

async function saveMem(id){
  const ct=document.getElementById('editContent').value.trim();
  const imp=parseFloat(document.getElementById('editImp').value);
  const layer=parseInt(document.getElementById('editLayer').value);
  const tags=document.getElementById('editTags').value.split(',').map(t=>t.trim()).filter(Boolean);
  try{
    await api('/memories/'+id,{method:'PATCH',body:JSON.stringify({content:ct,importance:imp,layer,tags})});
    toast('Saved');closeDetail();await refresh();
  }catch(e){toast('Error: '+e.message,false);}
}

async function deleteMem(id){
  if(!confirm('Delete?'))return;
  await api('/memories/'+id,{method:'DELETE'});
  toast('Deleted');closeDetail();await refresh();
}

function renderRecall(){
  document.getElementById('main').innerHTML=`
    <h2>Recall</h2>
    <div class="card">
      <div class="row"><input type="text" id="rQ" placeholder="Query..." style="flex:1" onkeydown="if(event.key==='Enter')doRecall()">
        <button class="btn" onclick="doRecall()">Recall</button></div>
      <div class="row" style="margin:0">
        <label><input type="checkbox" id="rExp"> expand</label>
        <label>limit <input type="number" id="rLim" value="10" min="1" max="50" style="width:50px"></label>
        <label>min score <input type="number" id="rMin" value="0.3" min="0" max="1" step=".05" style="width:55px"></label>
        <input type="text" id="rTags" placeholder="tags" style="width:100px">
        <select id="rKind" style="width:90px"><option value="">any</option><option>semantic</option><option>episodic</option><option>procedural</option></select>
      </div>
    </div>
    <div id="rRes"><div class="empty">Enter a query</div></div>`;
}

async function doRecall(){
  const q=document.getElementById('rQ').value.trim();if(!q)return;
  const body={query:q,limit:parseInt(document.getElementById('rLim').value)||10,
    expand:document.getElementById('rExp').checked,min_score:parseFloat(document.getElementById('rMin').value)||0};
  const tags=document.getElementById('rTags').value.trim();
  const kind=document.getElementById('rKind').value;
  if(tags)body.tags=tags.split(',').map(t=>t.trim());
  if(kind)body.kind=kind;
  document.getElementById('rRes').innerHTML='<div class="empty">Searching...</div>';
  const t0=performance.now();
  const d=await api('/recall',{method:'POST',body:JSON.stringify(body)});
  const ms=(performance.now()-t0).toFixed(0);
  const r=d.memories||[];
  document.getElementById('rRes').innerHTML=`
    <div style="font-size:11px;color:#555;margin:10px 0 6px">${r.length} results, ${ms}ms — ${d.search_mode||'?'}</div>
    <div class="ml">${r.length?r.map(m=>card(m,m.score,m.relevance)).join(''):'<div class="empty">Nothing found</div>'}</div>`;
  bindCards();
}

function renderSearch(){
  document.getElementById('main').innerHTML=`
    <h2>Search</h2>
    <div class="card">
      <div class="row" style="margin:0"><input type="text" id="sQ" placeholder="Search text..." style="flex:1" onkeydown="if(event.key==='Enter')doSearch()">
        <button class="btn" onclick="doSearch()">Search</button></div>
    </div>
    <div id="sRes"><div class="empty">Full-text search</div></div>`;
}

function renderResume(){
  document.getElementById('main').innerHTML=`
    <h2>Resume</h2>
    <div class="card">
      <div class="row" style="margin:0;gap:12px;flex-wrap:wrap">
        <label>Hours <input type="number" id="resHours" value="6" min="1" max="168" style="width:55px"></label>
        <label><input type="checkbox" id="resCompact"> compact</label>
        <label>Budget <input type="number" id="resBudget" value="0" min="0" style="width:70px" placeholder="0=unlimited"></label>
        <button class="btn" onclick="doResume()">Resume</button>
        <button class="btn" onclick="toggleRaw()" id="rawBtn" style="background:#333">Raw</button>
      </div>
    </div>
    <div id="resResult"><div class="empty">Hit Resume to see what an agent gets on wake-up</div></div>`;
}

let lastResumeData=null;
let showRaw=false;

function toggleRaw(){
  showRaw=!showRaw;
  const btn=document.getElementById('rawBtn');
  if(btn) btn.style.background=showRaw?'#1a6b3a':'#333';
  if(lastResumeData) renderResumeResult(lastResumeData.data,lastResumeData.ms);
}

function resumeToPrompt(r){
  let lines=[];
  lines.push('=== Session Resume ('+r.hours+'h) ===');
  lines.push('core: '+r.core_count+', working: '+r.working_count+', buffer: '+r.buffer_count+
    ', recent: '+r.recent_count+', sessions: '+r.session_count+', next: '+(r.next_action_count||0));
  lines.push('');
  function ts(m){return m.created_at?new Date(m.created_at).toLocaleTimeString('en',{hour:'2-digit',minute:'2-digit',hour12:false}):'';}
  function layerTag(m){return {1:'B',2:'W',3:'C'}[m.layer]||'';}
  function tags(m){return (m.tags||[]).length?' ['+m.tags.join(',')+']':'';}

  if(r.next_actions&&r.next_actions.length){
    lines.push('--- Next Actions ---');
    r.next_actions.forEach(m=>lines.push('  '+m.content));
    lines.push('');
  }
  if(r.core&&r.core.length){
    lines.push('--- Core ('+r.core.length+') ---');
    r.core.forEach(m=>lines.push('  [imp='+((m.importance||0).toFixed(2))+tags(m)+'] '+m.content));
    lines.push('');
  }
  if(r.working&&r.working.length){
    lines.push('--- Working ('+r.working.length+') ---');
    r.working.forEach(m=>lines.push('  ['+ts(m)+tags(m)+'] '+m.content));
    lines.push('');
  }
  if(r.sessions&&r.sessions.length){
    lines.push('--- Sessions ('+r.sessions.length+') ---');
    r.sessions.forEach(m=>lines.push('  ['+ts(m)+'] '+m.content));
    lines.push('');
  }
  if(r.recent&&r.recent.length){
    lines.push('--- Recent ('+r.recent.length+') ---');
    r.recent.forEach(m=>lines.push('  ['+layerTag(m)+'|'+ts(m)+tags(m)+'] '+m.content));
    lines.push('');
  }
  if(r.buffer&&r.buffer.length){
    lines.push('--- Buffer ('+r.buffer.length+') ---');
    r.buffer.forEach(m=>lines.push('  ['+ts(m)+tags(m)+'] '+m.content));
    lines.push('');
  }
  return lines.join('\n');
}

function renderResumeResult(r,ms){
  const countLine='core: '+(r.core_count||0)+', working: '+(r.working_count||0)+
    ', buffer: '+(r.buffer_count||0)+', recent: '+(r.recent_count||0)+
    ', sessions: '+(r.session_count||0)+', next: '+(r.next_action_count||0);

  if(showRaw){
    const raw=resumeToPrompt(r);
    const charCount=raw.length;
    const tokenEst=Math.round(charCount/3.5);
    document.getElementById('resResult').innerHTML=
      '<div style="font-size:11px;color:#555;margin:10px 0 8px">'+ms+'ms — '+countLine+
      ' — ~'+tokenEst+' tokens ('+charCount+' chars)</div>'+
      '<pre style="background:#111;border:1px solid #222;border-radius:6px;padding:14px;'+
      'font-size:12px;line-height:1.5;color:#ccc;white-space:pre-wrap;word-break:break-word;'+
      'max-height:80vh;overflow-y:auto;font-family:monospace">'+esc(raw)+'</pre>';
    return;
  }

  function memCard(m){
    const tags=(m.tags||[]).map(t=>'<span class="tag">'+esc(t)+'</span>').join(' ');
    const layer=m.layer?('<span class="lb l'+m.layer+'">'+ln(m.layer)+'</span>'):'';
    const ts=m.created_at?new Date(m.created_at).toLocaleString():'';
    return '<div class="mc" style="cursor:default"><div class="ct">'+esc(m.content||'')+'</div>'+
      '<div class="meta">'+layer+' <span>'+ts+'</span> '+tags+'</div></div>';
  }

  function section(title,items){
    if(!items||!items.length) return '';
    return '<div style="margin-bottom:16px"><b style="font-size:12px;color:#888">'+title+' ('+items.length+')</b>'+
      '<div class="ml" style="margin-top:6px">'+items.map(m=>memCard(m)).join('')+'</div></div>';
  }

  let html='<div style="font-size:11px;color:#555;margin:10px 0 12px">'+ms+'ms — '+countLine+'</div>';
  html+=section('Next Actions',r.next_actions);
  html+=section('Core',r.core);
  html+=section('Working',r.working);
  html+=section('Sessions',r.sessions);
  html+=section('Recent',r.recent);
  html+=section('Buffer',r.buffer);

  if(!html.includes('ml')) html='<div class="empty">Empty resume</div>';
  document.getElementById('resResult').innerHTML=html;
}

async function doResume(){
  const hours=parseInt(document.getElementById('resHours').value)||6;
  const compact=document.getElementById('resCompact').checked;
  const budget=parseInt(document.getElementById('resBudget').value)||0;
  let url='/resume?hours='+hours;
  if(compact) url+='&compact=true';
  if(budget>0) url+='&budget='+budget;
  document.getElementById('resResult').innerHTML='<div class="empty">Loading...</div>';
  const t0=performance.now();
  const r=await api(url);
  const ms=Math.round(performance.now()-t0);
  lastResumeData={data:r,ms};
  renderResumeResult(r,ms);
}

async function doSearch(){
  const q=document.getElementById('sQ').value.trim();if(!q)return;
  document.getElementById('sRes').innerHTML='<div class="empty">Searching...</div>';
  const t0=performance.now();
  const d=await api('/search?q='+encodeURIComponent(q));
  const ms=(performance.now()-t0).toFixed(0);
  const r=Array.isArray(d)?d:(d.memories||[]);
  document.getElementById('sRes').innerHTML=`
    <div style="font-size:11px;color:#555;margin:10px 0 6px">${r.length} results, ${ms}ms (FTS)</div>
    <div class="ml">${r.length?r.map(m=>card(m,m.relevance)).join(''):'<div class="empty">No results</div>'}</div>`;
  bindCards();
}

function renderCreate(){
  document.getElementById('main').innerHTML=`
    <h2>Create</h2>
    <div class="card" style="max-width:540px">
      <textarea id="ccontent" rows="4" placeholder="Content..." style="width:100%;margin-bottom:8px"></textarea>
      <input type="text" id="ctags" placeholder="Tags (comma-separated)" style="width:100%;margin-bottom:8px">
      <input type="text" id="csource" placeholder="Source" style="width:100%;margin-bottom:8px">
      <div class="row" style="margin:0 0 8px">
        <label>Kind <select id="ckind"><option>semantic</option><option>episodic</option><option>procedural</option></select></label>
        <label>Imp <input type="range" id="cimp" min="0" max="1" step=".05" value="0.5" oninput="document.getElementById('cimpv').textContent=this.value"><span id="cimpv">0.5</span></label>
        <label><input type="checkbox" id="csync"> sync embed</label>
      </div>
      <button class="btn" onclick="doCreate()">Create</button>
    </div>`;
}

async function doCreate(){
  const content=document.getElementById('ccontent').value.trim();if(!content)return;
  const tags=document.getElementById('ctags').value.split(',').map(t=>t.trim()).filter(Boolean);
  const source=document.getElementById('csource').value.trim();
  const kind=document.getElementById('ckind').value;
  const importance=parseFloat(document.getElementById('cimp').value);
  const sync_embed=document.getElementById('csync').checked;
  const body={content,kind,importance};
  if(tags.length)body.tags=tags;if(source)body.source=source;if(sync_embed)body.sync_embed=true;
  try{
    const m=await api('/memories',{method:'POST',body:JSON.stringify(body)});
    toast('Created '+m.id.slice(0,8));document.getElementById('ccontent').value='';
    loadMem();loadStats();
  }catch(e){toast(e.message,false);}
}

function renderFacts(){
  document.getElementById('main').innerHTML=`
    <h2>Facts</h2>
    <div class="card">
      <div class="row" style="margin:0">
        <input type="text" id="fSubj" placeholder="Subject" style="width:120px">
        <input type="text" id="fPred" placeholder="Predicate" style="width:120px">
        <input type="text" id="fObj" placeholder="Object" style="width:120px">
        <button class="btn" onclick="queryFacts()">Query</button>
        <button class="btn btn-ghost" onclick="loadAllFacts()">All</button>
        <button class="btn btn-ghost" onclick="loadConflicts()">Conflicts</button>
      </div>
    </div>
    <div id="fRes"></div>`;
  loadAllFacts();
}

async function loadAllFacts(){
  const d=await api('/facts/all');renderFactTable(d.facts||d||[],'All');
}
async function queryFacts(){
  const s=document.getElementById('fSubj').value.trim(),p=document.getElementById('fPred').value.trim(),o=document.getElementById('fObj').value.trim();
  let qs=[];if(s)qs.push('subject='+encodeURIComponent(s));if(p)qs.push('predicate='+encodeURIComponent(p));if(o)qs.push('object='+encodeURIComponent(o));
  const d=await api('/facts?'+qs.join('&'));renderFactTable(d.facts||d||[],'Results');
}
async function loadConflicts(){
  const d=await api('/facts/conflicts');const c=d.conflicts||d||[];
  if(!c.length){document.getElementById('fRes').innerHTML='<div class="empty">No conflicts</div>';return;}
  let h='';
  for(const g of c){
    h+=`<div class="card" style="border-color:#c0392b44"><div style="font-weight:600;margin-bottom:6px">${esc(g.subject)} → ${esc(g.predicate)}</div>`;
    for(const f of(g.facts||[]))h+=`<div style="display:flex;justify-content:space-between;padding:2px 0"><span>${esc(f.object)} <span style="color:#555;font-size:10px">${new Date(f.created_at).toLocaleDateString()}</span></span><button class="btn btn-danger" style="padding:1px 6px;font-size:10px" onclick="delFact('${f.id}')">×</button></div>`;
    h+='</div>';
  }
  document.getElementById('fRes').innerHTML=h;
}
function renderFactTable(facts,title){
  if(!facts.length){document.getElementById('fRes').innerHTML='<div class="empty">No facts</div>';return;}
  document.getElementById('fRes').innerHTML=`
    <div style="font-size:11px;color:#555;margin:10px 0 6px">${title}: ${facts.length}</div>
    <table class="ftable"><thead><tr><th>Subject</th><th>Predicate</th><th>Object</th><th>Created</th><th></th></tr></thead>
    <tbody>${facts.map(f=>`<tr><td>${esc(f.subject)}</td><td>${esc(f.predicate)}</td><td>${esc(f.object)}</td>
      <td style="font-size:10px;color:#555">${new Date(f.created_at).toLocaleDateString()}</td>
      <td><button class="btn btn-danger" style="padding:1px 6px;font-size:9px" onclick="delFact('${f.id}')">×</button></td></tr>`).join('')}</tbody></table>`;
}
async function delFact(id){if(!confirm('Delete?'))return;await api('/facts/'+id,{method:'DELETE'});toast('Deleted');loadAllFacts();}

function renderProxy(){
  const p=health.proxy||{},mems=allMem.filter(m=>m.source==='proxy');
  document.getElementById('main').innerHTML=`
    <h2>Proxy</h2>
    <div class="row" style="align-items:center;gap:8px;margin-bottom:12px">
      <span class="dot ${p.enabled?'on':'off'}"></span> ${p.enabled?'Active':'Inactive'}
    </div>
    <div class="stats">
      <div class="sc"><div class="v">${p.requests||0}</div><div class="l">Requests</div></div>
      <div class="sc"><div class="v">${p.buffered_turns||0}</div><div class="l">Buffered</div></div>
      <div class="sc"><div class="v">${p.extracted||0}</div><div class="l">Extracted</div></div>
      <div class="sc"><div class="v">${mems.length}</div><div class="l">Memories</div></div>
    </div>
    <div class="row"><button class="btn btn-ghost" onclick="doAction('/proxy/flush','POST')">Flush</button></div>
    <div class="ml">${mems.length?mems.map(m=>card(m)).join(''):'<div class="empty">No proxy memories</div>'}</div>`;
  bindCards();
}

function renderHealth(){
  const h=health,up=h.uptime_secs||0,c=h.embed_cache||{},p=h.proxy||{};
  const hr=c.hits+c.misses>0?((c.hits/(c.hits+c.misses))*100).toFixed(1):'—';
  document.getElementById('main').innerHTML=`
    <h2>Health</h2>
    <div class="stats">
      <div class="sc"><div class="v">${h.version||'?'}</div><div class="l">Version</div></div>
      <div class="sc"><div class="v">${Math.floor(up/3600)}h${Math.floor(up%3600/60)}m</div><div class="l">Uptime</div></div>
      <div class="sc"><div class="v">${h.rss_kb?Math.round(h.rss_kb/1024):'?'}</div><div class="l">RSS MB</div></div>
      <div class="sc"><div class="v">${h.db_size_mb||'?'}</div><div class="l">DB MB</div></div>
    </div>
    <div class="card"><b style="font-size:12px">Cache</b>
      <div class="stats" style="margin:8px 0 0">
        <div class="sc"><div class="v">${c.hits||0}</div><div class="l">Hits</div></div>
        <div class="sc"><div class="v">${c.misses||0}</div><div class="l">Misses</div></div>
        <div class="sc"><div class="v">${hr}%</div><div class="l">Hit rate</div></div>
        <div class="sc"><div class="v">${c.size||0}/${c.capacity||0}</div><div class="l">Size</div></div>
      </div>
    </div>
    <div class="card"><b style="font-size:12px">Proxy</b>
      <div class="stats" style="margin:8px 0 0">
        <div class="sc"><div class="v"><span class="dot ${p.enabled?'on':'off'}"></span></div><div class="l">Status</div></div>
        <div class="sc"><div class="v">${p.requests||0}</div><div class="l">Requests</div></div>
        <div class="sc"><div class="v">${p.extracted||0}</div><div class="l">Extracted</div></div>
        <div class="sc"><div class="v">${p.buffered_turns||0}</div><div class="l">Buffered</div></div>
      </div>
    </div>
    ${stats.by_kind?`<div class="card"><b style="font-size:12px">By kind</b>
      <div class="stats" style="margin:8px 0 0">
        ${Object.entries(stats.by_kind).map(([k,v])=>`<div class="sc"><div class="v">${v}</div><div class="l">${k}</div></div>`).join('')}
      </div>
    </div>`:''}
    ${h.integrity?`<div class="card"><b style="font-size:12px">Integrity</b>
      <div class="stats" style="margin:8px 0 0">
        <div class="sc"><div class="v"><span class="dot ${h.integrity.ok?'on':'off'}"></span></div><div class="l">Status</div></div>
        <div class="sc"><div class="v">${h.integrity.missing_embedding||0}</div><div class="l">Missing embed</div></div>
        <div class="sc"><div class="v">${h.integrity.missing_fts||0}</div><div class="l">Missing FTS</div></div>
        <div class="sc"><div class="v">${h.integrity.orphan_fts||0}</div><div class="l">Orphan FTS</div></div>
      </div>
    </div>`:''}`;
}

let trashPage=0,trashTotal=0;
const TPP=30;

async function loadTrashCount(){
  try{
    const d=await api('/trash?limit=1');
    const el=document.getElementById('c-trash');
    if(el) el.textContent=d.total||d.count||0;
  }catch(_){}
}

function renderTrash(){
  document.getElementById('main').innerHTML=`
    <h2>Trash</h2>
    <div class="row" style="margin-bottom:12px;gap:8px">
      <button class="btn" onclick="loadTrashPage(0)">Refresh</button>
      <button class="btn" style="background:#7f1d1d" onclick="purgeTrash()">Purge All</button>
    </div>
    <div id="trashList"><div class="empty">Loading...</div></div>
    <div id="trashPager"></div>`;
  loadTrashPage(0);
}

async function loadTrashPage(p){
  trashPage=Math.max(0,p);
  const offset=trashPage*TPP;
  const el=document.getElementById('trashList');
  const pgEl=document.getElementById('trashPager');
  try{
    const d=await api('/trash?limit='+TPP+'&offset='+offset);
    const items=d.items||[];
    trashTotal=d.total||items.length;
    if(!items.length&&trashTotal===0){el.innerHTML='<div class="empty">Trash is empty</div>';if(pgEl)pgEl.innerHTML='';return;}
    el.innerHTML='<div class="ml">'+items.map(t=>{
      const tags=(t.tags||[]).map(tg=>'<span class="tag">'+esc(tg)+'</span>').join(' ');
      const kind=t.kind&&t.kind!=='semantic'?'<span class="kind-badge">'+esc(t.kind)+'</span>':'';
      return '<div class="mc" style="opacity:0.85">'+
        '<div class="ct">'+esc((t.content||'').slice(0,280))+(t.content&&t.content.length>280?'…':'')+'</div>'+
        '<div class="meta">'+
          '<span class="lb l'+t.layer+'">'+ ({1:'Buffer',2:'Working',3:'Core'}[t.layer]||'?')+'</span>'+
          kind+
          '<span>imp '+(t.importance||0).toFixed(2)+'</span>'+
          '<span>'+ago(t.created_at)+'</span>'+
          '<span style="color:#c0392b">deleted '+ago(t.deleted_at)+'</span>'+
          tags+
        '</div>'+
        '<div style="margin-top:6px">'+
          '<button class="btn btn-ghost" style="font-size:11px" onclick="event.stopPropagation();restoreTrash(\''+t.id+'\')">Restore</button>'+
        '</div>'+
      '</div>';
    }).join('')+'</div>';
    const pages=Math.ceil(trashTotal/TPP);
    if(pgEl){
      if(pages>1){
        pgEl.innerHTML='<div class="pager">'+
          '<button onclick="loadTrashPage('+(trashPage-1)+')" '+(trashPage===0?'disabled':'')+'>Prev</button>'+
          '<span>'+(trashPage+1)+'/'+pages+' ('+trashTotal+')</span>'+
          '<button onclick="loadTrashPage('+(trashPage+1)+')" '+(trashPage>=pages-1?'disabled':'')+'>Next</button>'+
        '</div>';
      }else{
        pgEl.innerHTML='<div style="text-align:center;font-size:11px;color:#555;margin-top:10px">'+trashTotal+' items</div>';
      }
    }
  }catch(e){el.innerHTML='<div class="empty">'+esc(e.message)+'</div>';}
}

async function restoreTrash(id){
  try{
    await api('/trash/'+id+'/restore',{method:'POST'});
    toast('Restored');
    await refresh();
    loadTrashPage(trashPage);
    loadTrashCount();
  }catch(e){toast(e.message,false);}
}

async function purgeTrash(){
  if(!confirm('Permanently delete all trash? This cannot be undone.'))return;
  try{
    const d=await api('/trash',{method:'DELETE'});
    toast('Purged '+(d.purged||0)+' items');
    loadTrashPage(0);
    loadTrashCount();
  }catch(e){toast(e.message,false);}
}

function renderTools(){
  document.getElementById('main').innerHTML=`
    <h2>Tools</h2>
    <div class="card" style="max-width:540px">
      <div class="row" style="margin-bottom:12px">
        <button class="btn btn-ghost" onclick="doAction('/sanitize','POST')">Sanitize</button>
        <button class="btn btn-ghost" onclick="doAction('/vacuum','POST')">Vacuum</button>
        <button class="btn btn-ghost" onclick="doAction('/audit','POST','{}')">Audit</button>
        <button class="btn btn-ghost" onclick="doAction('/repair?force=true','POST')">Full rebuild</button>
      </div>
      <b style="font-size:12px">Extract from text</b>
      <textarea id="extText" rows="4" placeholder="Paste text..." style="width:100%;margin:6px 0"></textarea>
      <button class="btn" onclick="doExtract()" style="margin-bottom:12px">Extract</button>
      <div id="extRes"></div>
      <b style="font-size:12px">Import / Export</b>
      <div class="row" style="margin-top:6px">
        <button class="btn btn-ghost" onclick="doExport(false)">Export</button>
        <button class="btn btn-ghost" onclick="doExport(true)">Export + embeddings</button>
        <label class="btn btn-ghost" style="cursor:pointer">Import<input type="file" accept=".json" style="display:none" onchange="doImport(this)"></label>
      </div>
      <div id="impRes"></div>
    </div>`;
}

async function doExtract(){
  const text=document.getElementById('extText').value.trim();if(!text)return;
  document.getElementById('extRes').innerHTML='<div class="empty">Extracting...</div>';
  try{
    const d=await api('/extract',{method:'POST',body:JSON.stringify({text})});
    const mems=d.memories||d||[];
    document.getElementById('extRes').innerHTML=`<div style="font-size:11px;color:#555;margin:6px 0">Extracted ${mems.length}</div><div class="ml">${mems.map(m=>card(m)).join('')}</div>`;
    toast('Extracted '+mems.length);await refresh();
  }catch(e){toast(e.message,false);}
}
async function doExport(embed){
  const tk=localStorage.getItem('engram_token')||'';
  const res=await fetch(A+'/export'+(embed?'?embed=true':''),{headers:tk?{'Authorization':'Bearer '+tk}:{}});
  const blob=await res.blob();const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download='engram-export.json';a.click();toast('Downloaded');
}
async function doImport(input){
  const file=input.files[0];if(!file)return;const text=await file.text();
  try{const d=await api('/import',{method:'POST',body:text});
    toast('Imported '+(d.imported||0));
    document.getElementById('impRes').innerHTML=`<div style="color:#4caf50;font-size:12px;margin-top:6px">Imported ${d.imported||0}, skipped ${d.skipped||0}</div>`;
    await refresh();
  }catch(e){toast(e.message,false);}
}
async function doAction(path,method,body){
  try{const opts={method};if(body)opts.body=typeof body==='string'?body:JSON.stringify(body);
    const d=await api(path,opts);toast(path.slice(1)+': '+(typeof d==='string'?d:JSON.stringify(d)).slice(0,80));await refresh();
  }catch(e){toast(e.message,false);}
}

async function refresh(){await Promise.all([loadStats(),loadMem(),loadTrashCount()]);switchView(curView);}
function renderTests(){
  document.getElementById('main').innerHTML=`
    <h2>Tests</h2>
    <div class="row" style="margin-bottom:12px">
      <button class="btn" id="runAllBtn" onclick="runAllTests()">Run All</button>
      <span id="testSummary" style="font-size:11px;color:#555"></span>
    </div>
    <div id="testList" class="ml"></div>`;
  renderTestCards();
}

const testDefs=[
  {name:'Health check',fn:testHealth},
  {name:'Health data completeness',fn:testHealthFields},
  {name:'Stats',fn:testStats},
  {name:'Memory CRUD',fn:testMemoryCrud},
  {name:'Recall',fn:testRecall},
  {name:'Search',fn:testSearch},
  {name:'Facts CRUD',fn:testFactsCrud},
  {name:'Sort order',fn:testSortOrder},
];
let testResults={};

function renderTestCards(){
  const el=document.getElementById('testList');
  if(!el)return;
  el.innerHTML=testDefs.map((t,i)=>{
    const r=testResults[i];
    let status='<span style="color:#555">—</span>';
    let timing='';
    let detail='';
    if(r){
      if(r.running){status='<span style="color:#d4a44a">running...</span>';}
      else if(r.pass){status='<span style="color:#4caf50">PASS</span>';timing=r.ms+'ms';}
      else{status='<span style="color:#c0392b">FAIL</span>';timing=r.ms+'ms';detail=`<div style="color:#c0392b;font-size:11px;margin-top:4px">${esc(r.error)}</div>`;}
    }
    return`<div class="card" style="padding:10px 14px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:12px;color:#ccc">${esc(t.name)}</span>
        <span style="font-size:11px">${status} <span style="color:#555;margin-left:6px">${timing}</span></span>
      </div>${detail}</div>`;
  }).join('');
}

async function runAllTests(){
  const btn=document.getElementById('runAllBtn');
  btn.disabled=true;btn.textContent='Running...';
  testResults={};
  let passed=0,failed=0;
  for(let i=0;i<testDefs.length;i++){
    testResults[i]={running:true};renderTestCards();
    const t0=performance.now();
    try{
      await testDefs[i].fn();
      const ms=Math.round(performance.now()-t0);
      testResults[i]={pass:true,ms};passed++;
    }catch(e){
      const ms=Math.round(performance.now()-t0);
      testResults[i]={pass:false,ms,error:e.message||String(e)};failed++;
    }
    renderTestCards();
  }
  btn.disabled=false;btn.textContent='Run All';
  document.getElementById('testSummary').textContent=passed+' passed, '+failed+' failed';
}

function assert(cond,msg){if(!cond)throw new Error(msg||'assertion failed');}

async function testHealth(){
  const r=await api('/health');
  assert(r.version,'missing version field');
}

async function testHealthFields(){
  const r=await api('/health');
  assert(r.db_size_mb!==undefined,'missing db_size_mb');
  assert(r.rss_kb!==undefined,'missing rss_kb');
  assert(r.embed_cache,'missing embed_cache');
  assert(r.embed_cache.hits!==undefined,'missing embed_cache.hits');
  assert(r.embed_cache.misses!==undefined,'missing embed_cache.misses');
}

async function testStats(){
  const r=await api('/stats');
  assert(r.total!==undefined,'missing total');
  assert(r.buffer!==undefined,'missing buffer');
  assert(r.working!==undefined,'missing working');
  assert(r.core!==undefined,'missing core');
}

async function testMemoryCrud(){
  // create
  const m=await api('/memories',{method:'POST',body:JSON.stringify({content:'__test_crud_'+Date.now(),tags:['_test']})});
  assert(m.id,'create: no id returned');
  try{
    // read
    const got=await api('/memories/'+m.id);
    assert(got.id===m.id,'read: id mismatch');
    // update
    const updated='__test_updated_'+Date.now();
    await api('/memories/'+m.id,{method:'PATCH',body:JSON.stringify({content:updated})});
    const got2=await api('/memories/'+m.id);
    assert(got2.content===updated,'update: content not changed');
    // delete
    await api('/memories/'+m.id,{method:'DELETE'});
    // verify 404
    try{
      const tk=localStorage.getItem('engram_token')||'';
      const h={'Content-Type':'application/json'};
      if(tk)h['Authorization']='Bearer '+tk;
      const res=await fetch(A+'/memories/'+m.id,{headers:h});
      assert(res.status===404,'delete: expected 404 got '+res.status);
    }catch(e){if(e.message.startsWith('delete:'))throw e;}
  }catch(e){
    // cleanup on failure
    try{await api('/memories/'+m.id,{method:'DELETE'});}catch(_){}
    throw e;
  }
}

async function testRecall(){
  const r=await api('/recall',{method:'POST',body:JSON.stringify({query:'test',limit:5})});
  assert(Array.isArray(r.memories),'response missing memories array');
}

async function testSearch(){
  const r=await api('/search?q=test');
  // just verify we get an array response
  const arr=Array.isArray(r)?r:(r.memories||r);
  assert(Array.isArray(arr)||typeof r==='object','unexpected search response');
}

async function testFactsCrud(){
  const subj='_test_'+Date.now();
  // create — facts API expects {facts: [...]}
  const f=await api('/facts',{method:'POST',body:JSON.stringify({facts:[{subject:subj,predicate:'is',object:'a test'}]})});
  const fact=(f.facts&&f.facts[0]);
  const fid=fact?fact.id:null;
  const mid=fact?fact.memory_id:null;
  assert(fid,'create: no id');
  try{
    // query
    const q=await api('/facts?entity='+encodeURIComponent(subj));
    const facts=q.facts||q||[];
    assert(facts.length>0,'query: no facts found');
    // delete fact + cleanup auto-created memory
    await api('/facts/'+fid,{method:'DELETE'});
    if(mid) try{await api('/memories/'+mid,{method:'DELETE'});}catch(_){}
  }catch(e){
    try{await api('/facts/'+fid,{method:'DELETE'});}catch(_){}
    if(mid) try{await api('/memories/'+mid,{method:'DELETE'});}catch(_){}
    throw e;
  }
}

async function testSortOrder(){
  const d=await api('/memories?limit=20');
  const mems=Array.isArray(d)?d:(d.memories||[]);
  if(mems.length<2)return; // can't verify with fewer than 2
  for(let i=1;i<mems.length;i++){
    assert(mems[i-1].created_at>=mems[i].created_at,
      'not sorted: index '+(i-1)+' ('+mems[i-1].created_at+') < index '+i+' ('+mems[i].created_at+')');
  }
}

function switchView(v){
  curView=v;page=0;
  document.querySelectorAll('.nav li').forEach(li=>li.classList.toggle('active',li.dataset.v===v));
  if(v==='recall')renderRecall();else if(v==='search')renderSearch();else if(v==='resume')renderResume();else if(v==='create')renderCreate();
  else if(v==='facts')renderFacts();else if(v==='proxy')renderProxy();else if(v==='health')renderHealth();
  else if(v==='trash')renderTrash();else if(v==='tools')renderTools();else if(v==='tests')renderTests();else renderList(getMem());
}

document.querySelectorAll('.nav').forEach(n=>{n.onclick=e=>{const li=e.target.closest('li');if(li)switchView(li.dataset.v);};});
document.onkeydown=e=>{if(e.key==='Escape')closeDetail();if((e.metaKey||e.ctrlKey)&&e.key==='k'){e.preventDefault();switchView('search');setTimeout(()=>{const el=document.getElementById('sQ');if(el)el.focus();},50);}};
setInterval(()=>Promise.all([loadStats(),loadMem()]),30000);
refresh();
</script>
</body>
</html>
